@using System
@using System.Linq
@using System.Reflection
@inherits RazorEngine.Templating.TemplateBase<TeamCityBuildChanges.Output.ChangeManifest>
@{
    Func<string, string> extractUsername = userName =>
    {
        if (!string.IsNullOrEmpty(userName))
        {
            var userNameArray = userName.Split(' ');

            if (userName.IndexOf("\\") > 0)
            {
                return userName.Split('\\')[1];
            }
            if (userNameArray.Length > 1)
            {
                return userNameArray[0] + userNameArray[1].Substring(0, 1);
            }
        }

        return userName;
    };
}

@if (Model.IssueDetails != null && Model.IssueDetails.Any())
{
<h3>Work Items</h3>

<table>
    @foreach (var issue in Model.IssueDetails)
    {
    <tr>
        <td><img src='//www.oztix.com.au/app/oztix/img/@(extractUsername(issue.LastAssignedTo)).png' width='60' height='60' /></td>
        <td valign='top'><h6>@issue.Type (@(issue.LastAssignedTo))</h6><a href='https://tfsweb.ticketsolutions.com.au/tfs/DefaultCollection/_workitems/edit/@issue.Id' target='_blank'>@issue.Id</a> @issue.Summary</td>
    </tr>
    foreach (var child in issue.SubIssues)
    {
        <tr style="font-style: italic">
            <td><img src='//www.oztix.com.au/app/oztix/img/@(extractUsername(child.LastAssignedTo)).png' width='60' height='60' /></td>
            <td valign='top'><h6>@child.Type (@(child.LastAssignedTo))</h6><a href='https://tfsweb.ticketsolutions.com.au/tfs/DefaultCollection/_workitems/edit/@issue.Id'>@child.Id</a> @child.Summary</td>
        </tr>
        foreach (var subIssue in child.SubIssues)
        {
            <tr style="font-style: oblique">
                <td><img src='//www.oztix.com.au/app/oztix/img/@(extractUsername(subIssue.LastAssignedTo)).png' width='60' height='60' /></td>
                <td valign='top'><h6>@subIssue.Type (@(subIssue.LastAssignedTo))</h6><a href='https://tfsweb.ticketsolutions.com.au/tfs/DefaultCollection/_workitems/edit/@issue.Id'>@subIssue.Id</a> @subIssue.Summary</td>
            </tr>
        }
    }
    }
</table>

<hr />
}
else
{
<h3>No workitems</h3>
}

@if (Model.ChangeDetails != null && Model.ChangeDetails.Any())
{
<h3>Change Details</h3>

<table>
    @foreach (var change in Model.ChangeDetails)
    {
    <tr>
        <td><img src='//www.oztix.com.au/app/oztix/img/@(extractUsername(change.Username)).png' width='60' height='60'/></td>
        <td valign='top'><h6>Checked in by (@change.Username)</h6><a href='https://tfsweb.ticketsolutions.com.au/tfs/DefaultCollection/_versionControl/changeset/@change.Version' target='_blank'>Changeset @change.Version</a> @change.Comment</td>
    </tr>
    }
</table>

<hr />
}
else
{
<h3>No changesets</h3>
}
